# GolemDB Conversation Module for Next.js

A comprehensive TypeScript module for storing and managing conversation data on the GolemDB blockchain within Next.js applications. GolemDB is a Layer 3 Ethereum solution that stores data on-chain in JSON format. Conversations are identified by a unique `meetId` that is generated externally (e.g., from transaction hashes or sender/receiver wallet combinations).

## Features

- ✅ **Blockchain Storage**: Store conversations directly on GolemDB Layer 3 Ethereum
- ✅ **Complete CRUD Operations**: Create, read, update, and delete conversations by meet ID
- ✅ **TypeScript Support**: Full type safety with comprehensive interfaces
- ✅ **Next.js Integration**: Ready-to-use API routes and client-side helpers  
- ✅ **External ID Management**: Meet IDs provided by your application (from smart contracts, transaction hashes, etc.)
- ✅ **Blockchain Features**: BTL (blocks-to-live), transaction hashes, gas management
- ✅ **Data Validation**: Robust validation and sanitization
- ✅ **Error Handling**: Comprehensive error handling with specific error codes
- ✅ **Rate Limiting**: Built-in rate limiting for API endpoints
- ✅ **Privacy-First Design**: Conversations indexed by meet ID, not wallet address

## Quick Start

### 1. Environment Setup

Add these environment variables to your `.env.local` file:

```bash
# GolemDB Configuration
GOLEMDB_RPC_URL=https://golem-testnet.rpc.caldera.xyz/http
GOLEMDB_CHAIN_ID=9999999
GOLEMDB_PRIVATE_KEY=your_private_key_here

# Optional: Enable logging in development
GOLEMDB_ENABLE_LOGGING=true
```

### 2. Basic Usage

#### Server-side (API Routes)

```typescript
import { conversationManager } from '../golemdb';

// Store a conversation on the blockchain after video call ends
const result = await conversationManager.storeConversation({
  meetId: "0x7a9f...3b2c", // Transaction hash or custom ID from your app
  conversationLength: 45000, // 45 seconds in milliseconds
  transcript: "User: Hello! Assistant: Hi there!",
  walletAddress: "0x1234...5678" // Stored as metadata
});

// Returns blockchain transaction hash
console.log('Stored on blockchain:', result.transactionHash);

// Retrieve a specific conversation from blockchain by meet ID
const conversation = await conversationManager.getConversation("0x7a9f...3b2c");
```

#### Client-side (React Components)

```typescript
import { ConversationClient } from '../golemdb';

const client = new ConversationClient();

// Store conversation from frontend
const result = await client.storeConversation({
  meetId: meetIdFromSmartContract, // Get this from your smart contract or app logic
  conversationLength: 30000,
  transcript: "Conversation transcript here...",
  walletAddress: userWallet
});
```

### 3. API Endpoints

The module provides these Next.js API routes:

- `POST /api/conversations` - Store new conversation with meet ID
- `GET /api/conversations?meetId=...` - Get specific conversation by meet ID
- `PATCH /api/conversations/[meetId]` - Update existing conversation
- `DELETE /api/conversations/[meetId]` - Delete conversation

**Note**: All operations use the `meetId` provided by your application

## Data Structure

### ConversationEntity

```typescript
interface ConversationEntity {
  meetId: string;              // Unique ID from your app (transaction hash, etc.)
  conversationLength: number;  // Duration in milliseconds
  transcript: string;          // Full conversation transcript
  timestamp: number;           // Creation timestamp
  walletAddress: string;       // User's Ethereum address (metadata)
}
```

## Core Functions

### Meet ID Generation

The `meetId` is **NOT** generated by this module. It should be provided by your application based on:

1. **Transaction Hash**: When a smart contract creates the meeting
2. **Wallet Combination**: Hash of sender + receiver wallets
3. **Custom Logic**: Any unique identifier from your application

```typescript
// Example: Using transaction hash as meetId
const txHash = await contract.createMeeting(sender, receiver);
const meetId = txHash; // "0x7a9f...3b2c"

// Example: Using wallet combination
const meetId = generateMeetId(senderWallet, receiverWallet);
```

### storeConversation(conversationData)

Stores a new conversation in GolemDB with validation.

```typescript
const result = await conversationManager.storeConversation({
  meetId: "0x7a9f...3b2c", // Your app's meet ID
  conversationLength: 60000,
  transcript: "Full conversation text...",
  walletAddress: "0x1234...5678"
});
```

### getConversation(meetId)

Retrieves a specific conversation by its meet ID.

```typescript
const conversation = await conversationManager.getConversation(
  "0x7a9f...3b2c" // The meet ID from your app
);
```

### listConversations(query)

**Note**: This requires additional indexing implementation. Currently returns a message indicating indexing is needed.

```typescript
// Future implementation when indexing is added
const conversations = await conversationManager.listConversations({
  limit: 20,
  offset: 0,
  walletAddress: "0x1234...5678" // Optional filter if index exists
});
```

### updateConversation(meetId, updates)

Updates specific fields of an existing conversation.

```typescript
const updated = await conversationManager.updateConversation(
  "0x7a9f...3b2c",
  {
    transcript: "Updated transcript with additional analysis"
  }
);
```

### deleteConversation(meetId)

Removes a conversation from GolemDB.

```typescript
const result = await conversationManager.deleteConversation("0x7a9f...3b2c");
```

## Integration Examples

### Video Call Component

```typescript
import { VideoCallManager } from '../golemdb/examples';

const callManager = new VideoCallManager();

// Start tracking
callManager.startCall();

// Add transcript segments as they come
callManager.addTranscriptSegment("User said: Hello there!");

// End call and store conversation
const conversation = await callManager.endCall(userWalletAddress);
```

### React Hook for Conversations

```typescript
import { useConversations } from '../golemdb/examples';

function UserDashboard({ walletAddress }) {
  const { conversations, loading, error, storeConversation } = useConversations(walletAddress);

  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error}</div>;

  return (
    <div>
      <h2>Your Conversations ({conversations.length})</h2>
      {conversations.map(conv => (
        <div key={conv.conversationId}>
          {new Date(conv.timestamp).toLocaleDateString()} - 
          {Math.round(conv.conversationLength / 1000)}s
        </div>
      ))}
    </div>
  );
}
```

## Privacy & Security Considerations

### Architecture Design

- **Privacy-First**: Conversations are stored and retrieved by meet ID, not wallet address
- **External ID Management**: Meet IDs come from your application (smart contracts, transaction hashes, etc.)
- **No Direct Wallet Indexing**: Wallet address is stored only as metadata, not used for indexing

### On-chain Privacy

- **Data Visibility**: All conversation data stored in GolemDB may be publicly readable
- **Sensitive Information**: Avoid storing personal identifiers or sensitive content in transcripts
- **Encryption**: Consider client-side encryption for sensitive transcripts before storage

### Best Practices

1. **Signature Verification**: Implement wallet signature verification for write operations
2. **Data Minimization**: Only store necessary conversation data
3. **Access Control**: Implement proper authorization checks in API routes
4. **Rate Limiting**: Use built-in rate limiting to prevent abuse

## Error Handling

The module includes comprehensive error handling:

```typescript
try {
  const result = await conversationManager.storeConversation(data);
  if (result.success) {
    console.log('Stored:', result.data);
  } else {
    console.error('Failed:', result.error);
  }
} catch (error) {
  if (error instanceof ConversationError) {
    console.error('Validation error:', error.message);
  }
}
```

### Error Types

- `VALIDATION_ERROR` - Invalid input data
- `AUTHENTICATION_ERROR` - Wallet authentication failed  
- `NETWORK_ERROR` - GolemDB connection issues
- `ENTITY_NOT_FOUND` - Conversation doesn't exist
- `TRANSACTION_FAILED` - Blockchain transaction failed
- `INSUFFICIENT_FUNDS` - Not enough funds for transaction

## Development

### Setup

```bash
# Already installed with project dependencies
npm install golem-base-sdk

# Environment setup
cp env.config.txt .env.local
# Edit .env.local with your GolemDB configuration
```

### Testing

```bash
# Create mock data for testing
import { createMockConversation } from '../golemdb/examples';

const mockConv = await createMockConversation("0x1234...5678");
```

### Logging

Enable detailed logging in development:

```bash
export GOLEMDB_ENABLE_LOGGING=true
```

## Configuration

### GolemDB Testnet

Default configuration for GolemDB testnet:

- **RPC URL**: `https://golem-testnet.rpc.caldera.xyz/http`
- **Chain ID**: `9999999`
- **Network**: GolemDB Testnet

### Environment Variables

| Variable | Description | Required | Default |
|----------|-------------|----------|---------|
| `GOLEMDB_RPC_URL` | GolemDB RPC endpoint | Yes | testnet URL |
| `GOLEMDB_CHAIN_ID` | Chain ID for GolemDB | Yes | 9999999 |
| `GOLEMDB_PRIVATE_KEY` | Private key for transactions | Yes | - |
| `GOLEMDB_ENABLE_LOGGING` | Enable debug logging | No | false |

## Limitations & Considerations

1. **Storage Costs**: Each conversation requires a blockchain transaction with associated costs
2. **Public Data**: GolemDB data may be publicly readable; consider encryption for sensitive content
3. **Rate Limits**: Built-in rate limiting prevents abuse but may limit legitimate high-volume usage
4. **Transaction Finality**: Conversations are stored on-chain and cannot be easily modified once confirmed
5. **No Built-in User Index**: To retrieve all conversations for a user, you need to maintain meet IDs separately
6. **ID Management**: Applications must track meet IDs from smart contracts or other sources

## Support

For issues and questions:

1. Check the [GolemDB TypeScript SDK documentation](https://github.com/Golem-Base/typescript-sdk)
2. Review the examples in `app/golemdb/examples.ts`
3. Enable logging for debugging: `GOLEMDB_ENABLE_LOGGING=true`

## License

This module is part of the Web3 Onboarder Demo project.